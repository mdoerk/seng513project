Mustache = require('mustache'),
	fs = require('fs'), 
	fileUtil = require('fileUtil'), 
	Cache = require('cache').Cache; 

var layoutsPath = 'views/layouts/';
var defaultLayoutPath = layoutsPath + 'defaultLayout.html';
var defaultPageTitle = 'CivicConnect';
var defaultQuickTaskButtons = 'views/layouts/partials/defaultQuickTaskButtons_partial.html';
var fileCache = new Cache();  

/*
 * This method is intended to be added to the http.Response object.  
 */
exports.render = function(template, view, partials, send_fun) {
	res = this;
	view = view || {}; //Removes the need to pass in the 'view' argument.
	
	// TODO: Is it OK to assume 'text/html' at this point?
	res.setHeader('Content-Type', 'text/html');
	
	quickTaskButtons_partial = view.quickTaskButtons_partial || defaultQuickTaskButtons;
	
	retrieveFiles(generateLayout); 
	
	function retrieveFiles(callback) { 
		var filesToImport = []; 
		if (!fileCache.contains(template)) { filesToImport.push(template); }
		if (!fileCache.contains(defaultLayoutPath)) { filesToImport.push(defaultLayoutPath); } 
		if (!fileCache.contains(quickTaskButtons_partial)) { filesToImport.push(quickTaskButtons_partial); } 
		
		if (filesToImport.length == 0) { callback(); }  
		fileUtil.readFiles(filesToImport, function(err, results) { 
			if (err) throw err; 
			for (var i = 0; i < filesToImport.length; i++) {
				var filename = filesToImport[i]; 
				fileCache.add(filename, results[filename]); 
			}
			callback(); 
		}); 
	}
	
	function generateLayout() { 
		var contentData = fileCache.get(template); 
		var layoutData = fileCache.get(defaultLayoutPath); 
		var partialData = fileCache.get(quickTaskButtons_partial); 
		
		contentHTML = Mustache.to_html(contentData.toString(), view, partials, send_fun);
		
		res.request.getUser(function(error, user) {
			if (error) throw error; 
					
			layoutPartials = {}
			layoutPartials.quickTaskButtons = partialData.toString();
			
			layoutContent = view.layoutContent || {};
			layoutContent.content = contentHTML.toString();
			layoutContent.user = user;
			layoutContent.user_name = (user) ? user.name: '';
			layoutContent.error = view.error;
			layoutContent.pageTitle = layoutContent.pageTitle || view.pageTitle || defaultPageTitle;
			layoutContent.quickTaskButtons = view.quickTaskButtons;
				
			fullHTML = Mustache.to_html(layoutData.toString(), layoutContent, layoutPartials);

			res.write(fullHTML);
			res.end();
		});
	}
}

/*
 * This method is intended to be added to the http.Response ojbect.  
 */
exports.redirectTo = function(route){
	this.statusCode = 302;
	this.setHeader('Location', route);
	this.end();
}