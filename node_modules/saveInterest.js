var dbAccess = require('dbAccess.js');
var url = require('url');

var SaveInterest = exports.SaveInterest = function (){
};

/**
 * Send the HTML page to the client(redirection to the detail view).
 * @param response Response object to send the data
 * @param id Interest id to redirect
 */
 function displayInfo(response,user_id) {
    return function(error, rows) {		
        		
     if (error) {console.log("Error on Updating Interest"); throw error;}
     
      console.log("Interest saved.");
      redirectTo(response, '/editProfile?id='+ user_id); 
    };
}

function updateUserInterest(response, user_id, interest_topic, interest_location){
return function(error, interests)
	{
         if (error) throw error;
         
         if (interests.length > 0){ 
           //interest found update it 
           console.log("interest found update it ");
            dbAccess.update('interests', { values:['interest_topic="'+interest_topic+ '"','interest_location="'+ interest_location +'"'], conditions:['user_id="'+ user_id+ '"'] }, displayInfo(response,user_id));
	 
         } else { 
            //no interest found create it 
            console.log("no interest found create it");
            dbAccess.create('interests', { values:['user_id="'+ user_id+ '"','interest_topic="'+interest_topic+ '"','interest_location="'+ interest_location +'"']}, displayInfo(response,user_id));
	 
         }
	}
}

/**
 * Update the Interest with the new information
 * @param response Response object to send the data
 * @param POST post data
 */		
function postInterest(POST,response){
 
	user_id=POST.user_id; 
  interest_topic=POST.interest_topic; 
  interest_location=POST.interest_location;  
  
  console.log("user_id="+user_id);
  console.log("interest_topic="+interest_topic);
  console.log("interest_topic="+interest_topic);
 
 //get Interests of the user
  dbAccess.find('interests', { conditions:['user_id="' + user_id + '"'] },updateUserInterest(response, user_id,interest_topic,interest_location)); 
 
 }
 
 /**
 * Receive the POST data and pass it to the updateInterest funtion
 * @param response Response object to send the data
 * @param request Incoming request
 */   
function getPost(request,response){
	request.setEncoding("utf8");
	request.content = '';
	request.addListener("data", function(chunk) {
		request.content += chunk;
	});
 
	request.addListener("end", function() {
		var qs = require('querystring');
		POST=qs.parse(request.content);
		postInterest(POST,response);
	}); 
}

/**
 * Main function of the module to handle save
 * @param request Incoming request
 * @param response Response object to send the data
 */
SaveInterest.handleSave = function(request, response) {
   getPost(request,response); 
} 

