var dbAccess = require('dbAccess');
var url = require('url');

var FollowIssue = exports.FollowIssue = function() {};

FollowIssue.followIssue = function(req, res)
{
    req.getUser(function(error, user){
        if(error)
            throw error;
        if(user){
            var parsedURL = url.parse(req.url, true);
            var issue_id = parsedURL.query.id;
            var user_id = user.id;
            // User cannot follow an issue they are already following
            dbAccess.find('follows', { conditions:['user_id=' + user_id, 'issue_id=' + issue_id] }, function(error, data)
            {
                if(data.length == 0)
                {
                    dbAccess.create('follows', { values:['user_id=' + user_id, 'issue_id=' + issue_id]}, function(){});
                }
				redirectTo(res, '/viewIssue?id='+issue_id);
            });
        }
    });
}

FollowIssue.unfollowIssue = function(req, res)
{
    req.getUser(function(error, user){
        if(error)
            throw error;
        if(user){
            var parsedURL = url.parse(req.url, true);
            var issue_id = parsedURL.query.id;
            var user_id = user.id;
            console.log(user_id + " " + issue_id);
            dbAccess.remove('follows', { conditions:['user_id=' + user_id, 'issue_id=' + issue_id]}, function(){
				redirectTo(res, '/viewIssue?id='+issue_id);
			});
        }
    });
}
