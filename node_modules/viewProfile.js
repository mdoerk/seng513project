/* viewProfile.js 
 * Provides functionality for displaying a user's profile. 
 */ 

var dbAccess = require('dbAccess'), 
	url = require('url');

var ViewProfile = exports.ViewProfile = function() {};

/**
 * Display a profile page
 * @param request A http request object from the client
 * @param response A http response object to send the data
 */
ViewProfile.display = function(request, response) {
	var parsedURL = url.parse(request.url, true);
	var id = parsedURL.query.id;
	
	request.getUser(function(error, user) {
		if (error) throw error;
		var loggedIn = false;
		
		if (!id && user) { 
			id = user.id; 
			loggedIn = true; 
		} else if(id && user) {
			if(id == user.id)
				loggedIn = true;
		}		
		
		dbAccess.find('users', { conditions:['id="' + id + '"'] }, function(error, users) {
			if (error) throw error;
			// If the user_id specified is not found in the db - error
			if(users.length != 1) { // Properly handle if the user_id is not valid
				variables = { found: false, user_id: id }; 
				response.render('views/viewProfile.html', variables);
			}
			else { // If user_id is found, display personal information and the list of issues
				user = users[0];
				dbAccess.find('issues', { conditions:['user_id="' + user.id + '"'], orderby: 'created desc' }, 
					function(error, issues) {
					variables = {
						found: true,
						name: user.name,
						neighborhood: user.neighborhood || '',
						postal_code: user.postal_code || '',
						facebook_account: user.facebook_account || 'None',
						twitter_account: user.twitter_account || 'None',
						has_website: user.website,
						website: user.website || 'None',
						issues_list: issues,
						has_issues: issues.length > 0,
						is_loggedin: loggedIn, 
						reputation: user.reputation_score
					}; 
					response.render('views/viewProfile.html', variables);
				});
			}
		});
	});
}
