var dbAccess = require('dbAccess.js');
var url = require('url');

var SaveIssue = exports.SaveIssue = function() {
};

/**
 * Send the HTML page to the client(redirection to the detail view).
 * @param response Response object to send the data
 * @param id Issue id to redirect
 */
function serve(response,id) {
    return function(error, rows) {		
        		
     if (error) {console.log("Error Adding Issue"); throw error;}
     console.log("Issue saved.");
      
		response.writeHeader(200, {'Content-Type': 'text/html'});
		response.end(' Redirecting....... <script language="JavaScript"> self.location="viewIssue?id='+id+'"; </script>');
    };
}
/**
 * Update the DB with the new information
 * @param response Response object to send the data
 * @param POST post data
 */		
function updateDB(POST,response){

	title=POST.title; description=POST.description; location=POST.location; id=POST.id; link=POST.link; status=POST.status;
	var sqlQuery = 'UPDATE issues SET title="'+title+'",description="'+description+'",location="'+location+'",link="'+link+'", status="'+status +'" WHERE id=' + id;

	dbAccess.runQuery(sqlQuery, serve(response,id));
     }
 /**
 * Receive the POST data and pass it to the updateDB funtion
 * @param response Response object to send the data
 * @param request Incoming request
 */   
function getPost(request,response){
	request.setEncoding("utf8");
	request.content = '';
	request.addListener("data", function(chunk) {
		request.content += chunk;
	});
 
	request.addListener("end", function() {
		var qs = require('querystring');
		POST=qs.parse(request.content);
		updateDB(POST,response);
	});
	

}


/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
SaveIssue.display = function(request, response) {
   getPost(request,response);
    
}
