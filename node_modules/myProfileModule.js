var dbAccess = require('dbAccess');
var url = require('url');

var MyProfileModule = exports.MyProfileModule = function() {};

/**
 * Display my profile page
 * @param request Request object from the client
 * @param response Response object to send the data
 */
MyProfileModule.display = function(request, response)
{
	console.log("User login initiated");
	
	//process login
	var loginBody = '';
	request.on('data',function(chunk){
		loginBody +=chunk.toString();
	});
	
	//parse data when data all data is received
	request.on('end', function(){
	var loginInfo = qs.parse(loginBody);
	var username = loginInfo['username'];
	var password = loginInfo['password'];
	
	//find user id
	dbAccess.find('users', { conditions:['name="' + username + '"'] }, function(error, results) 
	{
		layoutTop(response);
        response.write('<div id="content">');
		
		// Content
		if(results.length != 1) // Found no of many profiles
		{
			response.write('<h1>Not Found</h1>');
		}
		else
		{
			 response.write('<h1>Interests</h1>');
			   dbAccess.find('profiles', { conditions:['user_id="' + results[0].id + '"'] }, function(error, rows) 
          	{
				 
				console.log("results found");
				if(rows.length == 0){
				// user has not add any interest to profile
				// add interest to profile
					response.write('<div id="interest_form">'); 
					response.write('<form id="interest-form" action="updateProfile" method="post" enctype="application/x-www-form-urlencoded" >');
					response.write('<Strong>Location Interests: </Strong><BR><textarea rows="5" cols="50" id="interest_location" name="interest_location" value="" ></textarea><BR>');
					response.write('<Strong>Topic Interests: </Strong><BR><textarea rows="5" cols="50" id="interest_topic" name="interest_topic" value="" ></textarea><BR>');
					response.write('<input type="submit" id="update-button" value="Update" />');
					response.write('<input type=HIDDEN NAME="userID" value="' +results[0].id + '">');
					response.write('</form>');
					response.write('</div>'); 
					//end content div
					response.write('</div>');
					layoutBottom(response);
				}else{
				// user have interest in profile
				// edit interest in profile
					response.write('<div id="interest_form">'); 
					response.write('<form id="interest-form" action="updateProfile" method="post" enctype="application/x-www-form-urlencoded" >');
                    response.write('<Strong>Location Interests: </Strong><BR><textarea rows="5" cols="50" id="interest_location" name="interest_location"  >'+rows[0].interest_location +'</textarea><BR>');
                    response.write('<Strong>Topic Interests: </Strong><BR><textarea rows="5" cols="50" id="interest_topic" name="interest_topic"  >'+ rows[0].interest_topic + '</textarea><BR>');
                    response.write('<input type="submit" id="update-button" value="Update" />');
                    response.write('<input type=HIDDEN NAME="userID" value="' +rows[0].user_id + '">');
                    response.write('</form>');
					response.write('</div>'); 
					//end content div
					response.write('</div>');
					layoutBottom(response);
				} 
				
			}); 
		}
		//end content div
		// response.write('</div>');
		// layoutBottom(response);
	});
	});
}

function layoutTop(response){
		// Header
		response.write('<head>');
        response.write('<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>');
        response.write('<link rel="stylesheet" href="css/style.css" type="text/css" />');
        response.write('<title>CivicConnect</title>');
        response.write('</head>');
        response.write('<body>');
        response.write('<div id="page">');
        response.write('<div id="header"><a href="#">join</a> | <a href="#">login</a></div>');
        response.write('<div id="menu">');
        response.write('<ul>');
        response.write('<li><a href="index.html">Home</a></li>');
        response.write('<li><a href="about.html">About</a></li>');
        response.write('</ul>');
        response.write('</div>');
        response.write('<div id="quick-task-bar">');
        response.write('<a href="#" id="add-issue-button">Add Issue</a>');
        response.write('<form id="search-form">');
        response.write('<input type="text" id="search-box" name="search" value="" />');
        response.write('<input type="submit" id="search-button" value="Search" />');
        response.write('</form>');
        response.write('</div>');
}
	
function layoutBottom(response){
		// Footer
		response.write('<div id="footer"><p>&copy; 2011 University of Calgary. All rights reserved.</p></div></div></body> </html>');
		response.end();
}
